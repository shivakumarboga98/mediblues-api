service: mediblues-api

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: eu-north-1
  memorySize: 512
  timeout: 30
  
  # VPC Configuration for RDS access - ONLY for database-dependent functions
  # This is intentionally empty - VPC will be configured per-function that needs RDS
  # See individual function definitions for VPC configuration
  
  # Environment variables available to all functions
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${env:NODE_ENV, 'development'}
    FRONTEND_URL: ${env:FRONTEND_URL}
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME}
    CLOUDFRONT_DOMAIN: ${env:CLOUDFRONT_DOMAIN}
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT, '3306'}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_POOL_MIN: ${env:DB_POOL_MIN, '1'}
    DB_POOL_MAX: ${env:DB_POOL_MAX, '2'}
    DB_WAIT_FOR_CONNECTIONS: ${env:DB_WAIT_FOR_CONNECTIONS, 'true'}
    DB_CONNECTION_LIMIT: ${env:DB_CONNECTION_LIMIT, '2'}
    DB_QUEUE_LIMIT: ${env:DB_QUEUE_LIMIT, '0'}
    JWT_SECRET: ${env:JWT_SECRET}
    ADMIN_EMAIL: ${env:ADMIN_EMAIL, 'admin@mediblues.com'}
    ADMIN_PASSWORD: ${env:ADMIN_PASSWORD, 'Admin@123'}
  
  # IAM Permissions for S3 and RDS access
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - "arn:aws:s3:::${env:S3_BUCKET_NAME}"
            - "arn:aws:s3:::${env:S3_BUCKET_NAME}/*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:*:*:*"
        - Effect: Allow
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            - ec2:AssignPrivateIpAddresses
            - ec2:UnassignPrivateIpAddresses
          Resource: "*"
  
  # HTTP API Configuration (faster & cheaper than REST API)
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:5173
        - http://localhost:5174
        - ${env:FRONTEND_URL}
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Requested-With
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      allowCredentials: false
      exposedResponseHeaders:
        - Content-Length
        - Content-Type
        - X-Request-Id
      maxAge: 3600

# Lambda functions
functions:
  health:
    handler: src/handlers/health.handler
    description: Health check endpoint
    events:
      - httpApi:
          path: /health
          method: GET
  
  # Admin Authentication
  adminLogin:
    handler: src/handlers/adminAuth.adminLogin
    description: Admin login endpoint - generates JWT token
    events:
      - httpApi:
          path: /admin/login
          method: POST
  
  getDashboardStatistics:
    handler: src/handlers/statistics.getDashboardStatistics
    description: Get dashboard statistics (counts and aggregations)
    timeout: 30
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /statistics
          method: POST
  
  uploadImage:
    handler: src/handlers/upload.uploadImage
    description: Upload image to S3 bucket
    timeout: 30
    events:
      - httpApi:
          path: /upload
          method: POST
    
  contact:
    handler: src/handlers/contact.handler
    description: Contact form submission endpoint
    events:
      - httpApi:
          path: /contact
          method: POST

  # Locations endpoints
  getLocations:
    handler: src/handlers/locations.getLocations
    description: Get all locations
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /locations
          method: GET

  getLocationsSimple:
    handler: src/handlers/locations.getLocationsSimple
    description: Get all locations with minimal data (optimized for dropdowns)
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /locations/list/simple
          method: GET

  getLocation:
    handler: src/handlers/locations.getLocation
    description: Get single location
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /locations/{id}
          method: GET

  createLocation:
    handler: src/handlers/locations.createLocation
    description: Create new location
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /locations
          method: POST

  updateLocation:
    handler: src/handlers/locations.updateLocation
    description: Update location
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /locations/{id}
          method: PUT
      - httpApi:
          path: /locations/update
          method: PUT

  deleteLocation:
    handler: src/handlers/locations.deleteLocation
    description: Delete location
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /locations/{id}
          method: DELETE

  # Departments endpoints
  getDepartments:
    handler: src/handlers/departments.getDepartments
    description: Get all departments
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /departments
          method: GET

  getDepartment:
    handler: src/handlers/departments.getDepartment
    description: Get single department
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /departments/{id}
          method: GET

  createDepartment:
    handler: src/handlers/departments.createDepartment
    description: Create new department
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /departments
          method: POST

  updateDepartment:
    handler: src/handlers/departments.updateDepartment
    description: Update department
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /departments/{id}
          method: PUT
      - httpApi:
          path: /departments/update
          method: PUT

  updateDepartmentContent:
    handler: src/handlers/departments.updateDepartmentContent
    description: Update department content (achievements, treatments, facilities)
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /departments/update-content
          method: PUT

  deleteDepartment:
    handler: src/handlers/departments.deleteDepartment
    description: Delete department
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /departments/{id}
          method: DELETE

  # Doctors endpoints
  getDoctors:
    handler: src/handlers/doctors.getDoctors
    description: Get all doctors
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /doctors
          method: GET

  getDoctor:
    handler: src/handlers/doctors.getDoctor
    description: Get single doctor
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /doctors/{id}
          method: GET

  createDoctor:
    handler: src/handlers/doctors.createDoctor
    description: Create new doctor
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /doctors
          method: POST

  updateDoctor:
    handler: src/handlers/doctors.updateDoctor
    description: Update doctor
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /doctors/{id}
          method: PUT
      - httpApi:
          path: /doctors/update
          method: PUT

  deleteDoctor:
    handler: src/handlers/doctors.deleteDoctor
    description: Delete doctor
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /doctors/{id}
          method: DELETE

  # Banners endpoints
  getBanners:
    handler: src/handlers/banners.getBanners
    description: Get all banners
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /banners
          method: GET

  getBanner:
    handler: src/handlers/banners.getBanner
    description: Get single banner
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /banners/{id}
          method: GET

  createBanner:
    handler: src/handlers/banners.createBanner
    description: Create new banner
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /banners
          method: POST

  updateBanner:
    handler: src/handlers/banners.updateBanner
    description: Update banner
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /banners/{id}
          method: PUT
      - httpApi:
          path: /banners/update
          method: PUT

  deleteBanner:
    handler: src/handlers/banners.deleteBanner
    description: Delete banner
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /banners/{id}
          method: DELETE

  # Contact Info endpoints
  getContactInfo:
    handler: src/handlers/contact.getContact
    description: Get active contact information
    events:
      - httpApi:
          path: /contact-info
          method: GET

  getAllContactInfo:
    handler: src/handlers/contact.getAllContacts
    description: Get all contact information entries
    events:
      - httpApi:
          path: /contact-info/all
          method: GET

  createContactInfo:
    handler: src/handlers/contact.createContact
    description: Create or update contact information
    events:
      - httpApi:
          path: /contact-info
          method: POST

  updateContactInfo:
    handler: src/handlers/contact.updateContact
    description: Update specific contact information entry
    events:
      - httpApi:
          path: /contact-info/{id}
          method: PUT
      - httpApi:
          path: /contact-info/update
          method: POST

  deleteContactInfo:
    handler: src/handlers/contact.deleteContact
    description: Delete contact information entry
    events:
      - httpApi:
          path: /contact-info/{id}
          method: DELETE

  # Appointments endpoints
  createAppointment:
    handler: src/handlers/appointments.createAppointment
    description: Create new appointment
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /appointments
          method: POST

  getAppointments:
    handler: src/handlers/appointments.getAppointments
    description: Get all appointments with filters and pagination
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /appointments/list
          method: POST

  getAppointmentById:
    handler: src/handlers/appointments.getAppointmentById
    description: Get single appointment
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /appointments/{id}
          method: GET

  updateAppointment:
    handler: src/handlers/appointments.updateAppointment
    description: Update appointment
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /appointments/{id}
          method: PUT

  deleteAppointment:
    handler: src/handlers/appointments.deleteAppointment
    description: Delete appointment
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /appointments/{id}
          method: DELETE

  # Packages endpoints
  getAllPackages:
    handler: src/handlers/packages.getAllPackages
    description: Get all health check packages
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /packages
          method: GET

  getPackageById:
    handler: src/handlers/packages.getPackageById
    description: Get single package
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /packages/get
          method: POST

  createPackage:
    handler: src/handlers/packages.createPackage
    description: Create new package
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /packages
          method: POST

  updatePackage:
    handler: src/handlers/packages.updatePackage
    description: Update package
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /packages/update
          method: PUT

  deletePackage:
    handler: src/handlers/packages.deletePackage
    description: Delete package
    vpc: ${self:custom.vpcConfig}
    events:
      - httpApi:
          path: /packages/delete
          method: POST

# Custom configuration
custom:
  serverless-offline:
    httpPort: 3000
    host: 0.0.0.0
    noPrependStageInUrl: true
  
  # VPC configuration - reusable across functions that need DB access
  vpcConfig:
    securityGroupIds:
      - sg-01720bc042b04757f
    subnetIds:
      - subnet-03875321c65c86b8e
      - subnet-019e419aac3fe4e9b
      - subnet-0c7f766c39c9b3d78
    
  dotenv:
    path: .env.production
    basePath: ./
    exclude:
      - AWS_REGION
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY

# Package optimization
package:
  individually: false
  patterns:
    - '!.git/**'
    - '!.env*'
    - '!README.md'
    - '!.gitignore'
    - '!scripts/**'
    - '!node_modules/aws-sdk/**'
