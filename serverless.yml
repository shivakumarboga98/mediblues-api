service: mediblues-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: eu-north-1
  memorySize: 512
  timeout: 29
  
  # Environment variables available to all functions
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${env:NODE_ENV, 'development'}
    S3_BUCKET_NAME: mediblues
    AWS_REGION: eu-north-1
  
  # IAM Permissions for S3 access
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource: "arn:aws:s3:::mediblues/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource: "arn:aws:s3:::mediblues"
  
  # HTTP API Configuration (faster & cheaper than REST API)
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:5173
        - http://localhost:5174
        - ${env:FRONTEND_URL, 'https://your-amplify-domain.amplifyapp.com'}
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: false
      exposedResponseHeaders:
        - Content-Length
        - X-Request-Id
      maxAge: 3600

# Lambda functions
functions:
  health:
    handler: src/handlers/health.handler
    description: Health check endpoint
    events:
      - httpApi:
          path: /health
          method: GET
  
  # Admin Authentication
  adminLogin:
    handler: src/handlers/adminAuth.adminLogin
    description: Admin login endpoint - generates JWT token
    events:
      - httpApi:
          path: /admin/login
          method: POST
  
  getDashboardStatistics:
    handler: src/handlers/statistics.getDashboardStatistics
    description: Get dashboard statistics (counts and aggregations)
    events:
      - httpApi:
          path: /statistics
          method: POST
  
  uploadImage:
    handler: src/handlers/upload.uploadImage
    description: Upload image to S3 bucket
    events:
      - httpApi:
          path: /upload
          method: POST
    
  contact:
    handler: src/handlers/contact.handler
    description: Contact form submission endpoint
    events:
      - httpApi:
          path: /contact
          method: POST

  # Locations endpoints
  getLocations:
    handler: src/handlers/locations.getLocations
    description: Get all locations
    events:
      - httpApi:
          path: /locations
          method: GET

  getLocationsSimple:
    handler: src/handlers/locations.getLocationsSimple
    description: Get all locations with minimal data (optimized for dropdowns)
    events:
      - httpApi:
          path: /locations/list/simple
          method: GET

  getLocation:
    handler: src/handlers/locations.getLocation
    description: Get single location
    events:
      - httpApi:
          path: /locations/{id}
          method: GET

  createLocation:
    handler: src/handlers/locations.createLocation
    description: Create new location
    events:
      - httpApi:
          path: /locations
          method: POST

  updateLocation:
    handler: src/handlers/locations.updateLocation
    description: Update location
    events:
      - httpApi:
          path: /locations/{id}
          method: PUT
      - httpApi:
          path: /locations/update
          method: PUT

  deleteLocation:
    handler: src/handlers/locations.deleteLocation
    description: Delete location
    events:
      - httpApi:
          path: /locations/{id}
          method: DELETE

  # Departments endpoints
  getDepartments:
    handler: src/handlers/departments.getDepartments
    description: Get all departments
    events:
      - httpApi:
          path: /departments
          method: GET

  getDepartment:
    handler: src/handlers/departments.getDepartment
    description: Get single department
    events:
      - httpApi:
          path: /departments/{id}
          method: GET

  createDepartment:
    handler: src/handlers/departments.createDepartment
    description: Create new department
    events:
      - httpApi:
          path: /departments
          method: POST

  updateDepartment:
    handler: src/handlers/departments.updateDepartment
    description: Update department
    events:
      - httpApi:
          path: /departments/{id}
          method: PUT
      - httpApi:
          path: /departments/update
          method: PUT

  updateDepartmentContent:
    handler: src/handlers/departments.updateDepartmentContent
    description: Update department content (achievements, treatments, facilities)
    events:
      - httpApi:
          path: /departments/update-content
          method: PUT

  deleteDepartment:
    handler: src/handlers/departments.deleteDepartment
    description: Delete department
    events:
      - httpApi:
          path: /departments/{id}
          method: DELETE

  # Doctors endpoints
  getDoctors:
    handler: src/handlers/doctors.getDoctors
    description: Get all doctors
    events:
      - httpApi:
          path: /doctors
          method: GET

  getDoctor:
    handler: src/handlers/doctors.getDoctor
    description: Get single doctor
    events:
      - httpApi:
          path: /doctors/{id}
          method: GET

  createDoctor:
    handler: src/handlers/doctors.createDoctor
    description: Create new doctor
    events:
      - httpApi:
          path: /doctors
          method: POST

  updateDoctor:
    handler: src/handlers/doctors.updateDoctor
    description: Update doctor
    events:
      - httpApi:
          path: /doctors/{id}
          method: PUT
      - httpApi:
          path: /doctors/update
          method: PUT

  deleteDoctor:
    handler: src/handlers/doctors.deleteDoctor
    description: Delete doctor
    events:
      - httpApi:
          path: /doctors/{id}
          method: DELETE

  # Banners endpoints
  getBanners:
    handler: src/handlers/banners.getBanners
    description: Get all banners
    events:
      - httpApi:
          path: /banners
          method: GET

  getBanner:
    handler: src/handlers/banners.getBanner
    description: Get single banner
    events:
      - httpApi:
          path: /banners/{id}
          method: GET

  createBanner:
    handler: src/handlers/banners.createBanner
    description: Create new banner
    events:
      - httpApi:
          path: /banners
          method: POST

  updateBanner:
    handler: src/handlers/banners.updateBanner
    description: Update banner
    events:
      - httpApi:
          path: /banners/{id}
          method: PUT
      - httpApi:
          path: /banners/update
          method: PUT

  deleteBanner:
    handler: src/handlers/banners.deleteBanner
    description: Delete banner
    events:
      - httpApi:
          path: /banners/{id}
          method: DELETE

  # Contact Info endpoints
  getContactInfo:
    handler: src/handlers/contact.getContact
    description: Get active contact information
    events:
      - httpApi:
          path: /contact-info
          method: GET

  getAllContactInfo:
    handler: src/handlers/contact.getAllContacts
    description: Get all contact information entries
    events:
      - httpApi:
          path: /contact-info/all
          method: GET

  createContactInfo:
    handler: src/handlers/contact.createContact
    description: Create or update contact information
    events:
      - httpApi:
          path: /contact-info
          method: POST

  updateContactInfo:
    handler: src/handlers/contact.updateContact
    description: Update specific contact information entry
    events:
      - httpApi:
          path: /contact-info/{id}
          method: PUT
      - httpApi:
          path: /contact-info/update
          method: POST

  deleteContactInfo:
    handler: src/handlers/contact.deleteContact
    description: Delete contact information entry
    events:
      - httpApi:
          path: /contact-info/{id}
          method: DELETE

  # Appointments endpoints
  createAppointment:
    handler: src/handlers/appointments.createAppointment
    description: Create new appointment
    events:
      - httpApi:
          path: /appointments
          method: POST

  getAppointments:
    handler: src/handlers/appointments.getAppointments
    description: Get all appointments with filters and pagination
    events:
      - httpApi:
          path: /appointments/list
          method: POST

  getAppointmentById:
    handler: src/handlers/appointments.getAppointmentById
    description: Get single appointment
    events:
      - httpApi:
          path: /appointments/{id}
          method: GET

  updateAppointment:
    handler: src/handlers/appointments.updateAppointment
    description: Update appointment
    events:
      - httpApi:
          path: /appointments/{id}
          method: PUT

  deleteAppointment:
    handler: src/handlers/appointments.deleteAppointment
    description: Delete appointment
    events:
      - httpApi:
          path: /appointments/{id}
          method: DELETE

  # Packages endpoints
  getAllPackages:
    handler: src/handlers/packages.getAllPackages
    description: Get all health check packages
    events:
      - httpApi:
          path: /packages
          method: GET

  getPackageById:
    handler: src/handlers/packages.getPackageById
    description: Get single package
    events:
      - httpApi:
          path: /packages/get
          method: POST

  createPackage:
    handler: src/handlers/packages.createPackage
    description: Create new package
    events:
      - httpApi:
          path: /packages
          method: POST

  updatePackage:
    handler: src/handlers/packages.updatePackage
    description: Update package
    events:
      - httpApi:
          path: /packages/update
          method: PUT

  deletePackage:
    handler: src/handlers/packages.deletePackage
    description: Delete package
    events:
      - httpApi:
          path: /packages/delete
          method: POST

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

# Custom configuration
custom:
  serverless-offline:
    httpPort: 3000
    host: 0.0.0.0
    noPrependStageInUrl: true
    
  dotenv:
    path: .env.${self:provider.stage}
    basePath: ./
    include:
      - NODE_ENV
      - FRONTEND_URL

# Package optimization
package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!.git/**'
    - '!.env*'
    - '!README.md'
    - '!.gitignore'
    - 'src/**'
    - 'package.json'
